

task createProcessTasks() {
	createSnapshotCommandTask 'execute', 'test'
}

task createCleanTasks() {
	createSnapshotCommandTask 'reset', 'clean'	
}

def createSnapshotCommandTask(taskName, command) {
	def prefix = "${command}_"

	eachSnapshot { snapshotDir ->
		def normalizedPath = snapshotDir.path.replaceAll(/[\., \/]/, "")

		tasks.create(type:Exec, name:"${prefix}$normalizedPath") {
			workingDir snapshotDir.absolutePath
			commandLine '../../../../analysis', command

			ignoreExitValue true			
		}
	}

	tasks.create(name:taskName) {
		dependsOn tasks.matching { it.name.startsWith(prefix) }
	}
}

task setup << {
	def buildFile = new File("snapshot-build.gradle")

	eachSnapshot { snapshotDir ->
		def writer = new File(snapshotDir, "build.gradle").newWriter()
		writer << buildFile.text
		writer.close()
	}
}

task clean << {
	eachSnapshot { snapshotDir ->
		new File(snapshotDir, "build.gradle").delete()
	}
}

def eachSnapshot(Closure closure) {
	def dataFolder = new File("data")
	dataFolder.eachDir { devFolder ->
		def srcDevFolder = new File(devFolder, "src")

		if(!srcDevFolder.exists()) {
			return
		}

		new File(devFolder, "src").eachDir { snapshotDir ->
			closure(snapshotDir)
		}
	}	
}

task wrapper(type: Wrapper) {
	gradleVersion = '1.8'
	scriptFile = "analysis"
}
